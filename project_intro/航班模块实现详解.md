# 航班模块实现详解

## 1. 模块文件结构

### 1.1 后端文件结构
```
src/main/java/com/atsp/
├── controller/
│   ├── FlightController.java        # 航班控制器
│   ├── OrderController.java         # 订单控制器
│   └── RefundController.java        # 退票控制器
├── service/
│   ├── FlightService.java           # 航班服务接口
│   ├── FlightServiceImpl.java       # 航班服务实现
│   ├── OrderService.java            # 订单服务接口
│   ├── OrderServiceImpl.java        # 订单服务实现
│   ├── RefundService.java           # 退票服务接口
│   └── RefundServiceImpl.java       # 退票服务实现
├── dao/
│   ├── FlightMapper.java            # 航班数据访问接口
│   ├── OrderMapper.java             # 订单数据访问接口
│   └── RefundMapper.java            # 退票数据访问接口
├── entity/
│   ├── Flight.java                  # 航班实体类
│   ├── Order.java                   # 订单实体类
│   └── Refund.java                  # 退票实体类
├── dto/
│   ├── FlightSearchDTO.java         # 航班搜索数据传输对象
│   ├── OrderCreateDTO.java          # 订单创建数据传输对象
│   └── RefundApplyDTO.java          # 退票申请数据传输对象
└── vo/
    ├── FlightVO.java                # 航班视图对象
    ├── OrderVO.java                 # 订单视图对象
    └── RefundVO.java                # 退票视图对象
```

### 1.2 前端文件结构
```
src/views/
├── flight/
│   ├── index.vue                    # 航班查询页面
│   ├── components/
│   │   ├── FlightSearch.vue         # 航班搜索组件
│   │   ├── FlightList.vue           # 航班列表组件
│   │   └── FlightDetail.vue         # 航班详情组件
│   └── order/
│       ├── OrderForm.vue            # 订单表单组件
│       ├── OrderList.vue            # 订单列表组件
│       └── OrderDetail.vue          # 订单详情组件
└── refund/
    ├── RefundApply.vue              # 退票申请页面
    └── RefundList.vue               # 退票列表页面
```

## 2. 核心功能实现

### 2.1 航班查询功能

#### 2.1.1 后端实现
```java
@RestController
@RequestMapping("/api/flight")
public class FlightController {
    @Autowired
    private FlightService flightService;
    
    @PostMapping("/search")
    public Result<Page<FlightVO>> searchFlights(@RequestBody FlightSearchDTO searchDTO) {
        return Result.success(flightService.searchFlights(searchDTO));
    }
}

@Service
public class FlightServiceImpl implements FlightService {
    @Autowired
    private FlightMapper flightMapper;
    
    @Override
    public Page<FlightVO> searchFlights(FlightSearchDTO searchDTO) {
        // 1. 构建查询条件
        LambdaQueryWrapper<Flight> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(StringUtils.isNotBlank(searchDTO.getDepartureCity()), 
                  Flight::getDepartureCity, searchDTO.getDepartureCity())
               .eq(StringUtils.isNotBlank(searchDTO.getArrivalCity()), 
                  Flight::getArrivalCity, searchDTO.getArrivalCity())
               .ge(searchDTO.getDepartureDate() != null, 
                  Flight::getDepartureTime, searchDTO.getDepartureDate());
        
        // 2. 执行分页查询
        Page<Flight> page = new Page<>(searchDTO.getPage(), searchDTO.getLimit());
        Page<Flight> result = flightMapper.selectPage(page, wrapper);
        
        // 3. 转换为VO对象
        return convertToVOPage(result);
    }
}
```

#### 2.1.2 前端实现
```vue
<!-- FlightSearch.vue -->
<template>
  <div class="flight-search">
    <el-form :model="searchForm" :rules="rules" ref="searchForm">
      <el-form-item label="出发城市" prop="departureCity">
        <el-input v-model="searchForm.departureCity"></el-input>
      </el-form-item>
      <el-form-item label="到达城市" prop="arrivalCity">
        <el-input v-model="searchForm.arrivalCity"></el-input>
      </el-form-item>
      <el-form-item label="出发日期" prop="departureDate">
        <el-date-picker v-model="searchForm.departureDate"></el-date-picker>
      </el-form-item>
      <el-button type="primary" @click="searchFlights">查询</el-button>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      searchForm: {
        departureCity: '',
        arrivalCity: '',
        departureDate: null,
        page: 1,
        limit: 10
      }
    }
  },
  methods: {
    async searchFlights() {
      try {
        const res = await this.$http.post('/api/flight/search', this.searchForm)
        this.$emit('search-result', res.data)
      } catch (error) {
        this.$message.error('查询失败')
      }
    }
  }
}
</script>
```

### 2.2 订单处理功能

#### 2.2.1 后端实现
```java
@RestController
@RequestMapping("/api/order")
public class OrderController {
    @Autowired
    private OrderService orderService;
    
    @PostMapping("/create")
    public Result<OrderVO> createOrder(@RequestBody OrderCreateDTO orderDTO) {
        return Result.success(orderService.createOrder(orderDTO));
    }
}

@Service
@Transactional(rollbackFor = Exception.class)
public class OrderServiceImpl implements OrderService {
    @Autowired
    private OrderMapper orderMapper;
    @Autowired
    private FlightService flightService;
    
    @Override
    public OrderVO createOrder(OrderCreateDTO orderDTO) {
        // 1. 检查航班座位
        if (!flightService.checkSeats(orderDTO.getFlightId(), orderDTO.getSeatCount())) {
            throw new BusinessException("座位不足");
        }
        
        // 2. 创建订单
        Order order = new Order();
        BeanUtils.copyProperties(orderDTO, order);
        order.setOrderNo(generateOrderNo());
        order.setStatus(OrderStatus.PENDING.getCode());
        
        // 3. 保存订单
        orderMapper.insert(order);
        
        // 4. 更新座位
        flightService.updateSeats(orderDTO.getFlightId(), orderDTO.getSeatCount());
        
        // 5. 转换为VO对象
        return convertToVO(order);
    }
}
```

#### 2.2.2 前端实现
```vue
<!-- OrderForm.vue -->
<template>
  <div class="order-form">
    <el-form :model="orderForm" :rules="rules" ref="orderForm">
      <el-form-item label="乘客信息" prop="passengers">
        <div v-for="(passenger, index) in orderForm.passengers" :key="index">
          <el-input v-model="passenger.name" placeholder="姓名"></el-input>
          <el-input v-model="passenger.idCard" placeholder="身份证号"></el-input>
        </div>
      </el-form-item>
      <el-form-item label="座位数量" prop="seatCount">
        <el-input-number v-model="orderForm.seatCount" :min="1"></el-input-number>
      </el-form-item>
      <el-button type="primary" @click="submitOrder">提交订单</el-button>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      orderForm: {
        flightId: null,
        passengers: [],
        seatCount: 1
      }
    }
  },
  methods: {
    async submitOrder() {
      try {
        const res = await this.$http.post('/api/order/create', this.orderForm)
        this.$message.success('订单创建成功')
        this.$router.push(`/order/detail/${res.data.orderNo}`)
      } catch (error) {
        this.$message.error('订单创建失败')
      }
    }
  }
}
</script>
```

## 3. 数据流转过程

### 3.1 航班查询流程
1. **前端发起请求**
   - 用户输入查询条件
   - 前端组件收集参数
   - 发送HTTP请求到后端

2. **后端处理**
   - Controller接收请求
   - Service层处理业务逻辑
   - DAO层查询数据库
   - 返回查询结果

3. **数据库操作**
   - 执行SQL查询
   - 返回查询结果集
   - 更新缓存数据

4. **结果返回**
   - 后端封装结果
   - 前端接收数据
   - 更新页面显示

### 3.2 订单处理流程
1. **订单创建**
   - 前端收集订单信息
   - 后端验证数据
   - 创建订单记录
   - 更新座位信息

2. **支付处理**
   - 调用支付接口
   - 更新订单状态
   - 发送支付通知
   - 更新座位状态

3. **订单完成**
   - 生成电子票据
   - 发送确认通知
   - 更新订单状态
   - 记录操作日志

### 3.3 退票处理流程
1. **退票申请**
   - 用户提交申请
   - 验证退票资格
   - 计算退票费用
   - 创建退票记录

2. **退款处理**
   - 验证退款信息
   - 执行退款操作
   - 更新订单状态
   - 释放座位资源

## 4. 数据库交互

### 4.1 航班表操作
```sql
-- 查询航班
SELECT * FROM flight 
WHERE departure_city = ? 
AND arrival_city = ? 
AND departure_time >= ? 
LIMIT ?, ?;

-- 更新座位
UPDATE flight 
SET available_seats = available_seats - ? 
WHERE id = ? AND available_seats >= ?;
```

### 4.2 订单表操作
```sql
-- 创建订单
INSERT INTO `order` (
    order_no, user_id, flight_id, 
    seat_count, total_amount, status
) VALUES (?, ?, ?, ?, ?, ?);

-- 更新订单状态
UPDATE `order` 
SET status = ? 
WHERE order_no = ?;
```

## 5. 缓存策略

### 5.1 航班信息缓存
```java
@Service
public class FlightServiceImpl implements FlightService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Cacheable(value = "flight", key = "#flightId")
    public FlightVO getFlightDetail(Long flightId) {
        return flightMapper.selectById(flightId);
    }
    
    @CacheEvict(value = "flight", key = "#flightId")
    public void updateFlight(FlightDTO flightDTO) {
        flightMapper.updateById(flightDTO);
    }
}
```

### 5.2 订单信息缓存
```java
@Service
public class OrderServiceImpl implements OrderService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public OrderVO getOrderDetail(String orderNo) {
        // 1. 查询缓存
        String key = "order:" + orderNo;
        OrderVO orderVO = (OrderVO) redisTemplate.opsForValue().get(key);
        
        if (orderVO == null) {
            // 2. 查询数据库
            Order order = orderMapper.selectByOrderNo(orderNo);
            orderVO = convertToVO(order);
            
            // 3. 更新缓存
            redisTemplate.opsForValue().set(key, orderVO, 1, TimeUnit.HOURS);
        }
        
        return orderVO;
    }
}
```

## 6. 异常处理

### 6.1 全局异常处理
```java
@ControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(BusinessException.class)
    public Result handleBusinessException(BusinessException e) {
        return Result.error(e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public Result handleException(Exception e) {
        log.error("系统异常", e);
        return Result.error("系统异常，请稍后重试");
    }
}
```

### 6.2 业务异常处理
```java
public class BusinessException extends RuntimeException {
    public BusinessException(String message) {
        super(message);
    }
}

// 使用示例
if (!flightService.checkSeats(flightId, seatCount)) {
    throw new BusinessException("座位不足");
}
```

## 7. 日志记录

### 7.1 操作日志
```java
@Aspect
@Component
public class OperationLogAspect {
    @Around("@annotation(operationLog)")
    public Object around(ProceedingJoinPoint point, OperationLog operationLog) {
        // 1. 记录操作日志
        String operation = operationLog.value();
        String operator = getCurrentUser();
        String params = JSON.toJSONString(point.getArgs());
        
        // 2. 执行目标方法
        Object result = point.proceed();
        
        // 3. 保存日志
        saveOperationLog(operation, operator, params, result);
        
        return result;
    }
}
```

### 7.2 异常日志
```java
@Aspect
@Component
public class ExceptionLogAspect {
    @AfterThrowing(pointcut = "execution(* com.atsp..*.*(..))", throwing = "e")
    public void afterThrowing(JoinPoint point, Exception e) {
        // 1. 获取异常信息
        String className = point.getTarget().getClass().getName();
        String methodName = point.getSignature().getName();
        String params = JSON.toJSONString(point.getArgs());
        
        // 2. 记录异常日志
        log.error("异常类：{}，方法：{}，参数：{}，异常信息：{}", 
                 className, methodName, params, e.getMessage());
    }
}
```

## 8. 性能优化

### 8.1 查询优化
1. **索引优化**
   - 合理设计索引
   - 避免索引失效
   - 定期维护索引

2. **SQL优化**
   - 使用分页查询
   - 避免全表扫描
   - 优化查询条件

### 8.2 缓存优化
1. **多级缓存**
   - 本地缓存
   - Redis缓存
   - 数据库缓存

2. **缓存策略**
   - 缓存预热
   - 缓存更新
   - 缓存失效

## 9. 安全措施

### 9.1 接口安全
1. **参数验证**
   - 输入验证
   - 参数加密
   - 签名验证

2. **访问控制**
   - 权限验证
   - 频率限制
   - 黑名单控制

### 9.2 数据安全
1. **数据加密**
   - 敏感数据加密
   - 传输数据加密
   - 密码加盐

2. **数据备份**
   - 定时备份
   - 增量备份
   - 异地备份

## 10. 文件详细说明

### 10.1 后端文件说明

#### Controller层
1. **FlightController.java**
   - 功能：处理航班相关的HTTP请求
   - 主要接口：
     - 航班查询
     - 航班详情
     - 座位查询
   - 职责：参数校验、请求转发、响应封装

2. **OrderController.java**
   - 功能：处理订单相关的HTTP请求
   - 主要接口：
     - 创建订单
     - 订单支付
     - 订单查询
   - 职责：订单流程控制、状态管理

3. **RefundController.java**
   - 功能：处理退票相关的HTTP请求
   - 主要接口：
     - 退票申请
     - 退款处理
     - 退票查询
   - 职责：退票流程控制、退款处理

#### Service层
1. **FlightService.java & FlightServiceImpl.java**
   - 功能：航班业务逻辑处理
   - 核心方法：
     - 航班查询
     - 座位管理
     - 价格计算
   - 职责：业务规则实现、数据校验

2. **OrderService.java & OrderServiceImpl.java**
   - 功能：订单业务逻辑处理
   - 核心方法：
     - 订单创建
     - 订单状态管理
     - 支付处理
   - 职责：订单流程控制、事务管理

3. **RefundService.java & RefundServiceImpl.java**
   - 功能：退票业务逻辑处理
   - 核心方法：
     - 退票资格验证
     - 退票费用计算
     - 退款处理
   - 职责：退票规则实现、退款流程控制

#### DAO层
1. **FlightMapper.java**
   - 功能：航班数据访问接口
   - 主要操作：
     - 航班信息CRUD
     - 座位数量更新
     - 条件查询
   - 职责：数据库交互、SQL执行

2. **OrderMapper.java**
   - 功能：订单数据访问接口
   - 主要操作：
     - 订单信息CRUD
     - 订单状态更新
     - 订单查询
   - 职责：订单数据持久化

3. **RefundMapper.java**
   - 功能：退票数据访问接口
   - 主要操作：
     - 退票记录CRUD
     - 退款状态更新
     - 退票查询
   - 职责：退票数据持久化

#### Entity层
1. **Flight.java**
   - 功能：航班实体类
   - 主要属性：
     - 航班基本信息
     - 座位信息
     - 价格信息
   - 职责：数据映射、业务对象封装

2. **Order.java**
   - 功能：订单实体类
   - 主要属性：
     - 订单基本信息
     - 乘客信息
     - 支付信息
   - 职责：订单数据封装

3. **Refund.java**
   - 功能：退票实体类
   - 主要属性：
     - 退票基本信息
     - 退款信息
     - 状态信息
   - 职责：退票数据封装

#### DTO层
1. **FlightSearchDTO.java**
   - 功能：航班搜索参数封装
   - 主要属性：
     - 出发地
     - 目的地
     - 日期
   - 职责：参数传输、数据校验

2. **OrderCreateDTO.java**
   - 功能：订单创建参数封装
   - 主要属性：
     - 航班信息
     - 乘客信息
     - 座位信息
   - 职责：订单创建参数传输

3. **RefundApplyDTO.java**
   - 功能：退票申请参数封装
   - 主要属性：
     - 订单信息
     - 退票原因
     - 退款信息
   - 职责：退票申请参数传输

#### VO层
1. **FlightVO.java**
   - 功能：航班信息展示对象
   - 主要属性：
     - 航班详情
     - 座位状态
     - 价格信息
   - 职责：前端数据展示

2. **OrderVO.java**
   - 功能：订单信息展示对象
   - 主要属性：
     - 订单详情
     - 乘客信息
     - 支付状态
   - 职责：订单信息展示

3. **RefundVO.java**
   - 功能：退票信息展示对象
   - 主要属性：
     - 退票详情
     - 退款信息
     - 处理状态
   - 职责：退票信息展示

### 10.2 前端文件说明

#### 页面组件
1. **index.vue**
   - 功能：航班查询主页面
   - 主要组件：
     - 搜索表单
     - 航班列表
     - 分页控件
   - 职责：页面布局、组件协调

2. **FlightSearch.vue**
   - 功能：航班搜索组件
   - 主要功能：
     - 条件输入
     - 参数验证
     - 搜索触发
   - 职责：搜索条件收集

3. **FlightList.vue**
   - 功能：航班列表组件
   - 主要功能：
     - 数据展示
     - 排序筛选
     - 分页处理
   - 职责：航班信息展示

4. **FlightDetail.vue**
   - 功能：航班详情组件
   - 主要功能：
     - 详细信息展示
     - 座位选择
     - 价格计算
   - 职责：航班详情展示

#### 订单组件
1. **OrderForm.vue**
   - 功能：订单表单组件
   - 主要功能：
     - 乘客信息收集
     - 座位选择
     - 订单提交
   - 职责：订单信息收集

2. **OrderList.vue**
   - 功能：订单列表组件
   - 主要功能：
     - 订单展示
     - 状态管理
     - 操作处理
   - 职责：订单管理界面

3. **OrderDetail.vue**
   - 功能：订单详情组件
   - 主要功能：
     - 订单信息展示
     - 支付处理
     - 退票申请
   - 职责：订单详情展示

#### 退票组件
1. **RefundApply.vue**
   - 功能：退票申请页面
   - 主要功能：
     - 退票原因选择
     - 退款信息确认
     - 申请提交
   - 职责：退票申请处理

2. **RefundList.vue**
   - 功能：退票列表页面
   - 主要功能：
     - 退票记录展示
     - 状态查询
     - 退款跟踪
   - 职责：退票记录管理