# 航班模块实现详解

## 1. 数据库设计

### 1.1 航班信息表 (jipiao)
```sql
CREATE TABLE `jipiao` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '主键',
  `jipiao_name` varchar(200) DEFAULT NULL COMMENT '航班标题',
  `jipiao_photo` varchar(200) DEFAULT NULL COMMENT '航班照片',
  `jipiao_types` int DEFAULT NULL COMMENT '航班类型',
  `jipiao_new_money` decimal(10,2) DEFAULT NULL COMMENT '现价',
  `jipiao_chufadi` varchar(200) DEFAULT NULL COMMENT '出发地',
  `jipiao_mudidi` varchar(200) DEFAULT NULL COMMENT '目的地',
  `jipiao_time` timestamp NULL DEFAULT NULL COMMENT '出发时间',
  `zuowei_number` int DEFAULT NULL COMMENT '座位',
  `shangxia_types` int DEFAULT NULL COMMENT '是否上架',
  `hangban_types` int DEFAULT NULL COMMENT '航班状态',
  `jipiao_delete` int DEFAULT NULL COMMENT '逻辑删除',
  `jipiao_content` longtext COMMENT '航班详情',
  `create_time` timestamp NULL DEFAULT NULL COMMENT '创建时间'
)
```

### 1.2 航班收藏表 (jipiao_collection)
```sql
CREATE TABLE `jipiao_collection` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '主键',
  `jipiao_id` int DEFAULT NULL COMMENT '航班',
  `yonghu_id` int DEFAULT NULL COMMENT '用户',
  `jipiao_collection_types` int DEFAULT NULL COMMENT '类型',
  `insert_time` timestamp NULL DEFAULT NULL COMMENT '收藏时间',
  `create_time` timestamp NULL DEFAULT NULL COMMENT '创建时间'
)
```

### 1.3 机票预订表 (jipiao_order)
```sql
CREATE TABLE `jipiao_order` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '主键',
  `jipiao_order_uuid_number` varchar(200) DEFAULT NULL COMMENT '订单号',
  `jipiao_id` int DEFAULT NULL COMMENT '机票',
  `yonghu_id` int DEFAULT NULL COMMENT '用户',
  `jipiao_order_true_price` decimal(10,2) DEFAULT NULL COMMENT '实付价格',
  `jipiao_order_types` int DEFAULT NULL COMMENT '订单类型',
  `buy_zuowei_number` varchar(200) DEFAULT NULL COMMENT '预定座位',
  `buy_zuowei_time` date DEFAULT NULL COMMENT '订购日期',
  `insert_time` timestamp NULL DEFAULT NULL COMMENT '订单创建时间',
  `create_time` timestamp NULL DEFAULT NULL COMMENT '创建时间'
)
```

## 2. 核心功能实现

### 2.1 航班管理功能

#### 2.1.1 航班列表查询
```java
@RequestMapping("/page")
public R page(@RequestParam Map<String, Object> params, HttpServletRequest request){
    // 角色权限验证
    String role = String.valueOf(request.getSession().getAttribute("role"));
    if("用户".equals(role))
        params.put("yonghuId",request.getSession().getAttribute("userId"));
    
    // 只查询未删除的航班
    params.put("jipiaoDeleteStart",1);
    params.put("jipiaoDeleteEnd",1);
    
    // 执行分页查询
    PageUtils page = jipiaoService.queryPage(params);
    
    // 字典表数据转换
    List<JipiaoView> list = (List<JipiaoView>)page.getList();
    for(JipiaoView c:list){
        dictionaryService.dictionaryConvert(c, request);
    }
    
    return R.ok().put("data", page);
}
```

#### 2.1.2 航班详情查询
```java
@RequestMapping("/info/{id}")
public R info(@PathVariable("id") Long id, HttpServletRequest request){
    JipiaoEntity jipiao = jipiaoService.selectById(id);
    if(jipiao !=null){
        JipiaoView view = new JipiaoView();
        BeanUtils.copyProperties(jipiao, view);
        dictionaryService.dictionaryConvert(view, request);
        return R.ok().put("data", view);
    }
    return R.error(511,"查不到数据");
}
```

#### 2.1.3 航班取消功能
```java
@RequestMapping("/quxiaohangban")
public R quxiaohangban(Integer id, HttpServletRequest request){
    JipiaoEntity jipiaoEntity = new JipiaoEntity();
    jipiaoEntity.setId(id);
    jipiaoEntity.setHangbanTypes(2); // 设置航班状态为取消
    jipiaoService.updateById(jipiaoEntity);
    return R.ok();
}
```

### 2.2 航班收藏功能

#### 2.2.1 收藏航班
```java
@RequestMapping("/add")
public R add(@RequestBody JipiaoCollectionEntity jipiaoCollection, HttpServletRequest request){
    // 获取当前用户ID
    String userId = String.valueOf(request.getSession().getAttribute("userId"));
    jipiaoCollection.setYonghuId(Integer.valueOf(userId));
    
    // 检查是否已收藏
    JipiaoCollectionEntity existCollection = jipiaoCollectionService.selectOne(
        new EntityWrapper<JipiaoCollectionEntity>()
            .eq("jipiao_id", jipiaoCollection.getJipiaoId())
            .eq("yonghu_id", userId)
    );
    
    if(existCollection != null){
        return R.error("已经收藏过了");
    }
    
    // 保存收藏记录
    jipiaoCollection.setInsertTime(new Date());
    jipiaoCollectionService.insert(jipiaoCollection);
    return R.ok();
}
```

#### 2.2.2 取消收藏
```java
@RequestMapping("/delete")
public R delete(@RequestBody Integer[] ids, HttpServletRequest request){
    // 获取当前用户ID
    String userId = String.valueOf(request.getSession().getAttribute("userId"));
    
    // 删除收藏记录
    jipiaoCollectionService.delete(
        new EntityWrapper<JipiaoCollectionEntity>()
            .eq("jipiao_id", ids)
            .eq("yonghu_id", userId)
    );
    return R.ok();
}
```

### 2.3 机票预订功能

#### 2.3.1 创建订单
```java
@RequestMapping("/add")
public R add(@RequestBody JipiaoOrderEntity jipiaoOrder, HttpServletRequest request){
    // 获取当前用户ID
    String userId = String.valueOf(request.getSession().getAttribute("userId"));
    jipiaoOrder.setYonghuId(Integer.valueOf(userId));
    
    // 生成订单号
    String orderNumber = new Date().getTime() + userId;
    jipiaoOrder.setJipiaoOrderUuidNumber(orderNumber);
    
    // 设置订单创建时间
    jipiaoOrder.setInsertTime(new Date());
    
    // 保存订单
    jipiaoOrderService.insert(jipiaoOrder);
    return R.ok();
}
```

#### 2.3.2 订单支付
```java
@RequestMapping("/pay")
public R pay(@RequestBody JipiaoOrderEntity jipiaoOrder, HttpServletRequest request){
    // 更新订单状态为已支付
    jipiaoOrder.setJipiaoOrderTypes(2); // 2表示已支付
    jipiaoOrderService.updateById(jipiaoOrder);
    return R.ok();
}
```

#### 2.3.3 订单取消
```java
@RequestMapping("/cancel")
public R cancel(@RequestBody Integer id, HttpServletRequest request){
    JipiaoOrderEntity jipiaoOrder = new JipiaoOrderEntity();
    jipiaoOrder.setId(id);
    jipiaoOrder.setJipiaoOrderTypes(3); // 3表示已取消
    jipiaoOrderService.updateById(jipiaoOrder);
    return R.ok();
}
```

## 3. 数据流转过程

### 3.1 航班查询流程
1. 前端发起查询请求
2. 后端接收请求参数
3. 根据用户角色过滤数据
4. 执行分页查询
5. 转换字典表数据
6. 返回查询结果

### 3.2 航班预订流程
1. 用户选择航班和座位
2. 系统生成订单号
3. 创建订单记录
4. 更新座位状态
5. 返回订单信息

### 3.3 航班取消流程
1. 管理员发起取消请求
2. 系统更新航班状态
3. 通知相关用户
4. 处理已预订订单

## 4. 安全措施

### 4.1 权限控制
- 基于角色的访问控制
- 用户只能查看和操作自己的数据
- 管理员拥有全部操作权限

### 4.2 数据验证
- 输入参数验证
- 业务规则验证
- 防止重复提交

## 5. 文件说明

### 5.1 控制器文件
- `JipiaoController.java`: 处理航班相关的HTTP请求
  - 航班列表查询
  - 航班详情查询
  - 航班取消功能
  - 航班信息管理

- `JipiaoOrderController.java`: 处理订单相关的HTTP请求
  - 订单创建
  - 订单支付
  - 订单取消
  - 订单查询

- `JipiaoCollectionController.java`: 处理收藏相关的HTTP请求
  - 添加收藏
  - 取消收藏
  - 收藏列表查询

### 5.2 服务文件
- `JipiaoService.java`: 航班业务逻辑接口
  - 航班信息管理
  - 座位管理
  - 航班状态管理

- `JipiaoServiceImpl.java`: 航班业务逻辑实现
  - 实现航班服务接口
  - 处理业务逻辑
  - 数据验证和转换

- `JipiaoOrderService.java`: 订单业务逻辑接口
  - 订单创建和管理
  - 订单状态更新
  - 订单查询

- `JipiaoOrderServiceImpl.java`: 订单业务逻辑实现
  - 实现订单服务接口
  - 处理订单相关业务
  - 订单数据验证

### 5.3 实体文件
- `JipiaoEntity.java`: 航班实体类
  - 航班基本信息
  - 座位信息
  - 状态信息

- `JipiaoOrderEntity.java`: 订单实体类
  - 订单基本信息
  - 支付信息
  - 状态信息

- `JipiaoCollectionEntity.java`: 收藏实体类
  - 收藏关系信息
  - 时间信息

### 5.4 视图文件
- `JipiaoView.java`: 航班视图对象
  - 航班展示信息
  - 状态转换
  - 数据格式化

- `JipiaoOrderView.java`: 订单视图对象
  - 订单展示信息
  - 状态转换
  - 数据格式化

- `JipiaoCollectionView.java`: 收藏视图对象
  - 收藏展示信息
  - 关联数据
  - 数据格式化

### 5.5 数据访问文件
- `JipiaoDao.java`: 航班数据访问接口
  - 航班数据CRUD操作
  - 条件查询
  - 统计查询

- `JipiaoOrderDao.java`: 订单数据访问接口
  - 订单数据CRUD操作
  - 订单查询
  - 订单统计

- `JipiaoCollectionDao.java`: 收藏数据访问接口
  - 收藏数据CRUD操作
  - 收藏查询
  - 收藏统计

## 6. 项目包结构说明

### 6.1 核心功能包

#### 6.1.1 controller包 (`/com/controller/`)
- 作用：处理HTTP请求，是系统的入口层
- 航班模块相关文件：
  - `JipiaoController.java` - 处理航班相关的请求
  - `JipiaoOrderController.java` - 处理订单相关的请求
  - `JipiaoCollectionController.java` - 处理收藏相关的请求
- 主要职责：
  - 接收前端请求
  - 参数验证
  - 调用服务层
  - 返回响应结果

#### 6.1.2 service包 (`/com/service/`)
- 作用：实现业务逻辑，是系统的核心层
- 航班模块相关文件：
  - `JipiaoService.java` - 航班业务逻辑接口
  - `JipiaoOrderService.java` - 订单业务逻辑接口
  - `JipiaoCollectionService.java` - 收藏业务逻辑接口
- 主要职责：
  - 实现业务规则
  - 处理业务逻辑
  - 事务管理
  - 数据验证

#### 6.1.3 entity包 (`/com/entity/`)
- 作用：定义数据库实体类，对应数据库表结构
- 航班模块相关文件：
  - `JipiaoEntity.java` - 航班表实体
  - `JipiaoOrderEntity.java` - 订单表实体
  - `JipiaoCollectionEntity.java` - 收藏表实体
- 主要职责：
  - 映射数据库表
  - 定义实体属性
  - 提供数据访问方法

#### 6.1.4 dao包 (`/com/dao/`)
- 作用：数据访问层，负责与数据库交互
- 航班模块相关文件：
  - `JipiaoDao.java` - 航班数据访问接口
  - `JipiaoOrderDao.java` - 订单数据访问接口
  - `JipiaoCollectionDao.java` - 收藏数据访问接口
- 主要职责：
  - 执行SQL操作
  - 数据持久化
  - 数据查询

### 6.2 支持功能包

#### 6.2.1 model包 (`/com/model/`)
- 作用：存放数据传输对象(DTO)和视图对象(VO)
- 航班模块相关文件：
  - 航班查询参数DTO
  - 订单创建参数DTO
  - 航班展示VO
  - 订单展示VO
- 主要职责：
  - 数据传输
  - 数据展示
  - 参数封装

#### 6.2.2 utils包 (`/com/utils/`)
- 作用：工具类，提供通用功能
- 航班模块使用的工具：
  - 日期处理工具
  - 字符串处理工具
  - 加密解密工具
- 主要职责：
  - 提供通用方法
  - 功能复用
  - 代码优化

#### 6.2.3 config包 (`/com/config/`)
- 作用：配置类，系统配置信息
- 航班模块使用的配置：
  - 数据库配置
  - 缓存配置
  - 安全配置
- 主要职责：
  - 系统配置
  - 环境配置
  - 功能配置

#### 6.2.4 interceptor包 (`/com/interceptor/`)
- 作用：拦截器，用于请求拦截和预处理
- 航班模块使用的拦截器：
  - 用户认证拦截器
  - 权限验证拦截器
  - 日志记录拦截器
- 主要职责：
  - 请求拦截
  - 权限控制
  - 日志记录

#### 6.2.5 annotation包 (`/com/annotation/`)
- 作用：自定义注解
- 航班模块使用的注解：
  - 权限控制注解
  - 日志记录注解
  - 数据验证注解
- 主要职责：
  - 功能标记
  - 行为控制
  - 代码简化

#### 6.2.6 thread包 (`/com/thread/`)
- 作用：多线程相关类
- 航班模块使用的线程：
  - 订单处理线程
  - 消息通知线程
  - 定时任务线程
- 主要职责：
  - 异步处理
  - 并发控制
  - 任务调度

#### 6.2.7 ServletContextListener包 (`/com/ServletContextListener/`)
- 作用：Servlet上下文监听器
- 航班模块使用的监听器：
  - 系统启动初始化
  - 缓存预热
  - 资源加载
- 主要职责：
  - 系统初始化
  - 资源管理
  - 生命周期控制

### 6.3 数据流转过程

1. **请求处理流程**
   - 前端发起请求
   - 经过拦截器处理
   - 进入Controller层
   - 调用Service层
   - 通过DAO层访问数据库
   - 返回处理结果

2. **数据转换流程**
   - 数据库数据 → Entity对象
   - Entity对象 → DTO/VO对象
   - DTO/VO对象 → 前端展示

3. **业务处理流程**
   - 参数验证
   - 业务规则检查
   - 数据处理
   - 结果返回

### 6.4 分层架构优点

1. **职责分明**
   - 每层各司其职
   - 代码结构清晰
   - 维护方便

2. **代码复用**
   - 通用功能封装
   - 工具类复用
   - 配置集中管理

3. **扩展性强**
   - 接口设计
   - 模块独立
   - 易于扩展

4. **测试方便**
   - 层次分明
   - 依赖清晰
   - 易于单元测试

5. **维护性好**
   - 代码规范
   - 结构清晰
   - 易于调试