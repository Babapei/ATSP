# 航旅服务平台 - 后端实现

## 🛠 技术栈

### 1. 核心框架
- **Spring Boot 2.2.2** - 应用框架
- **MyBatis Plus 2.3** - ORM框架
- **Apache Shiro** - 安全框架
- **Maven** - 项目管理

### 2. 数据库
- **MySQL** - 主数据库
- **Redis** - 缓存（可选）

### 3. 工具库
- **FastJson** - JSON处理
- **Apache POI** - Excel处理
- **Hutool** - 工具包
- **百度AI SDK** - 人工智能服务

## 📦 项目结构

```
src/main/java/com/
├── annotation/      # 自定义注解
├── config/          # 配置类
├── controller/      # 控制器
├── dao/            # 数据访问层
├── entity/         # 实体类
├── interceptor/    # 拦截器
├── service/        # 服务层
└── utils/          # 工具类
```

## 🔧 核心功能实现

### 1. 用户认证与授权

#### Shiro配置
```java
@Configuration
public class ShiroConfig {
    @Bean
    public ShiroFilterFactoryBean shiroFilterFactoryBean(SecurityManager securityManager) {
        ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
        shiroFilterFactoryBean.setSecurityManager(securityManager);
        
        // 配置拦截器链
        Map<String, String> filterChainDefinitionMap = new LinkedHashMap<>();
        filterChainDefinitionMap.put("/api/auth/**", "anon");
        filterChainDefinitionMap.put("/api/**", "authc");
        
        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);
        return shiroFilterFactoryBean;
    }
}
```

#### 登录实现
```java
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    @Autowired
    private UserService userService;
    
    @PostMapping("/login")
    public Result login(@RequestBody LoginDTO loginDTO) {
        try {
            Subject subject = SecurityUtils.getSubject();
            UsernamePasswordToken token = new UsernamePasswordToken(
                loginDTO.getUsername(), 
                loginDTO.getPassword()
            );
            subject.login(token);
            return Result.success();
        } catch (AuthenticationException e) {
            return Result.error("用户名或密码错误");
        }
    }
}
```

### 2. 航班管理

#### 航班查询
```java
@Service
public class FlightServiceImpl implements FlightService {
    @Autowired
    private FlightMapper flightMapper;
    
    @Override
    public Page<FlightVO> searchFlights(FlightSearchDTO searchDTO) {
        Page<Flight> page = new Page<>(searchDTO.getPage(), searchDTO.getLimit());
        
        LambdaQueryWrapper<Flight> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(StringUtils.isNotBlank(searchDTO.getDepartureCity()), 
                  Flight::getDepartureCity, searchDTO.getDepartureCity())
               .eq(StringUtils.isNotBlank(searchDTO.getArrivalCity()), 
                  Flight::getArrivalCity, searchDTO.getArrivalCity())
               .ge(searchDTO.getDepartureDate() != null, 
                  Flight::getDepartureTime, searchDTO.getDepartureDate());
               
        return flightMapper.selectPage(page, wrapper);
    }
}
```

#### 订单处理
```java
@Service
@Transactional(rollbackFor = Exception.class)
public class OrderServiceImpl implements OrderService {
    @Autowired
    private OrderMapper orderMapper;
    @Autowired
    private FlightService flightService;
    
    @Override
    public Result createOrder(OrderDTO orderDTO) {
        // 1. 检查航班座位
        if (!flightService.checkSeats(orderDTO.getFlightId(), orderDTO.getSeatCount())) {
            return Result.error("座位不足");
        }
        
        // 2. 创建订单
        Order order = new Order();
        BeanUtils.copyProperties(orderDTO, order);
        order.setOrderNo(generateOrderNo());
        order.setStatus(OrderStatus.PENDING.getCode());
        
        // 3. 保存订单
        orderMapper.insert(order);
        
        // 4. 更新座位
        flightService.updateSeats(orderDTO.getFlightId(), orderDTO.getSeatCount());
        
        return Result.success(order);
    }
}
```

### 3. 文件上传

#### 配置
```yaml
spring:
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB
```

#### 实现
```java
@RestController
@RequestMapping("/api/upload")
public class UploadController {
    @Value("${upload.path}")
    private String uploadPath;
    
    @PostMapping("/image")
    public Result uploadImage(@RequestParam("file") MultipartFile file) {
        try {
            // 1. 检查文件类型
            String contentType = file.getContentType();
            if (!contentType.startsWith("image/")) {
                return Result.error("只支持图片上传");
            }
            
            // 2. 生成文件名
            String fileName = UUID.randomUUID().toString() + 
                            getFileExtension(file.getOriginalFilename());
            
            // 3. 保存文件
            File dest = new File(uploadPath + fileName);
            file.transferTo(dest);
            
            return Result.success(fileName);
        } catch (IOException e) {
            return Result.error("上传失败");
        }
    }
}
```

### 4. 缓存实现

#### Redis配置
```java
@Configuration
@EnableCaching
public class RedisConfig {
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // 设置key的序列化方式
        template.setKeySerializer(new StringRedisSerializer());
        // 设置value的序列化方式
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        return template;
    }
}
```

#### 缓存使用
```java
@Service
public class FlightServiceImpl implements FlightService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Cacheable(value = "flight", key = "#flightId")
    public FlightVO getFlightDetail(Long flightId) {
        return flightMapper.selectById(flightId);
    }
    
    @CacheEvict(value = "flight", key = "#flightId")
    public void updateFlight(FlightDTO flightDTO) {
        flightMapper.updateById(flightDTO);
    }
}
```

## 🔒 安全实现

### 1. 接口安全
- **参数验证**
  - 使用@Valid注解
  - 自定义验证器
  - 统一异常处理

- **SQL注入防护**
  - 使用MyBatis参数化查询
  - 输入过滤
  - 特殊字符转义

### 2. 数据安全
- **敏感数据加密**
  - 密码加密存储
  - 传输数据加密
  - 日志脱敏

- **权限控制**
  - 基于角色的访问控制
  - 数据权限控制
  - 操作日志记录

## 📊 性能优化

### 1. 数据库优化
- **索引优化**
  - 合理设计索引
  - 避免索引失效
  - 定期维护索引

- **SQL优化**
  - 避免全表扫描
  - 使用批量操作
  - 分页查询优化

### 2. 缓存优化
- **多级缓存**
  - 本地缓存
  - Redis缓存
  - 缓存预热

- **缓存策略**
  - 缓存更新
  - 缓存穿透防护
  - 缓存雪崩防护

## 🔄 部署方案

### 1. 环境配置
```yaml
spring:
  profiles:
    active: prod
  datasource:
    url: jdbc:mysql://localhost:3306/atsp
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
```

### 2. 部署步骤
1. **环境准备**
   - JDK 1.8
   - MySQL 5.7+
   - Redis（可选）

2. **项目打包**
   ```bash
   mvn clean package -Dmaven.test.skip=true
   ```

3. **部署运行**
   ```bash
   java -jar atsp.jar --spring.profiles.active=prod
   ```

### 3. 监控方案
- **日志监控**
  - ELK日志收集
  - 异常告警
  - 性能监控

- **系统监控**
  - JVM监控
  - 线程监控
  - 内存监控 